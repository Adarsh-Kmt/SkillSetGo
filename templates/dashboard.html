{% extends "base.html" %}

{% block title %}SkillSetGo - Student Dashboard{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h2 class="text-gradient mb-2">
                    <i class="fas fa-tachometer-alt me-2"></i>Your Dashboard
                </h2>
                <p class="text-muted mb-0">Welcome back! Here's your placement overview.</p>
            </div>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
            </a>
        </div>
    </div>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                <i class="fas fa-info-circle me-2"></i>{{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

{% if error %}
<div class="alert alert-danger">
    <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
</div>
{% endif %}

<!-- Quick Navigation Section -->
<div class="card mb-4 shadow-custom border-0">
    <div class="card-header text-white" style="background: var(--primary-color);">
        <h5 class="mb-0">
            <i class="fas fa-compass me-2"></i>Quick Navigation
        </h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <button class="btn btn-outline-primary w-100 quick-nav-btn" data-target="profile-section">
                    <i class="fas fa-user me-2"></i>Profile
                </button>
            </div>
            {% if job_offers %}
            <div class="col-md-4">
                <button class="btn btn-outline-success w-100 quick-nav-btn" data-target="offers-section">
                    <i class="fas fa-gift me-2"></i>Job Offers
                </button>
            </div>
            {% endif %}
            {% if applied_jobs %}
            <div class="col-md-4">
                <button class="btn btn-outline-primary w-100 quick-nav-btn" data-target="applications-section">
                    <i class="fas fa-paper-plane me-2"></i>Applications
                </button>
            </div>
            {% endif %}
            {% if jobs %}
            <div class="col-md-4">
                <button class="btn btn-outline-primary w-100 quick-nav-btn" data-target="available-jobs-section">
                    <i class="fas fa-briefcase me-2"></i>Available Jobs
                </button>
            </div>
            {% endif %}
            {% if interviews %}
            <div class="col-md-4">
                <button class="btn btn-outline-primary w-100 quick-nav-btn" data-target="interviews-section">
                    <i class="fas fa-calendar-alt me-2"></i>Interviews
                </button>
            </div>
            {% else %}
            <div class="col-md-4">
                <button class="btn btn-outline-primary w-100 quick-nav-btn" data-target="interviews-section">
                    <i class="fas fa-calendar-alt me-2"></i>Interviews
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Profile Section -->
<div class="card mb-4 shadow-custom border-0" id="profile-section">
    <div class="card-header text-white" style="background: var(--primary-color);">
        <h5 class="mb-0">
            <i class="fas fa-user me-2"></i>Profile Information
        </h5>
    </div>
    <div class="card-body">
        {% if profile %}
        <div class="row g-4">
            <div class="col-md-6">
                <div class="profile-item">
                    <label class="text-muted small">Full Name</label>
                    <p class="fw-semibold mb-2 text-muted">
                        <i class="fas fa-user text-primary me-2"></i>{{ profile.name }}
                    </p>
                </div>
                <div class="profile-item">
                    <label class="text-muted small">USN</label>
                    <p class="fw-semibold mb-2 text-muted">
                        <i class="fas fa-id-card text-primary me-2"></i>{{ profile.usn }}
                    </p>
                </div>
                <div class="profile-item">
                    <label class="text-muted small">Branch</label>
                    <p class="fw-semibold mb-2 text-muted">
                        <i class="fas fa-graduation-cap text-primary me-2"></i>{{ profile.branch }}
                    </p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="profile-item">
                    <label class="text-muted small">CGPA</label>
                    <p class="fw-semibold mb-2 text-muted">
                        <i class="fas fa-chart-line text-success me-2"></i>{{ profile.cgpa }}
                    </p>
                </div>
                <div class="profile-item">
                    <label class="text-muted small">Batch</label>
                    <p class="fw-semibold mb-2 text-muted">
                        <i class="fas fa-calendar text-primary me-2"></i>{{ profile.batch }}
                    </p>
                </div>
                <div class="profile-item">
                    <label class="text-muted small">Email</label>
                    <p class="fw-semibold mb-2 text-muted">
                        <i class="fas fa-envelope text-primary me-2"></i>{{ profile.email_id }}
                    </p>
                </div>
            </div>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-user-times text-muted fs-2 mb-3"></i>
            <p class="text-muted">No profile information available.</p>
            <a href="#" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Complete Profile
            </a>
        </div>
        {% endif %}
    </div>
</div>

<style>
.profile-item {
    margin-bottom: 1rem;
}

.profile-item label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
}

.offer-card {
    background: var(--primary-color);
    color: white;
    border: none !important;
    transition: all 0.3s ease;
}

.offer-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
}

.status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    border-radius: 50px;
    font-weight: 600;
    font-size: 0.875rem;
}

.status-accepted {
    background: var(--success-color);
    color: white;
}

.status-rejected {
    background: var(--danger-color);
    color: white;
}

.status-pending {
    background: var(--warning-color);
    color: white;
}

.quick-nav-btn {
    transition: all 0.3s ease;
    border-width: 2px;
    font-weight: 500;
    padding: 0.75rem 1rem;
}

.quick-nav-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.quick-nav-btn:active {
    transform: translateY(0);
}

.quick-nav-btn i {
    transition: transform 0.3s ease;
}

.quick-nav-btn:hover i {
    transform: scale(1.1);
}
</style>

<!-- Job Offers Section -->
{% if job_offers %}
<div class="card mb-4 shadow-custom border-0" id="offers-section">
    <div class="card-header text-white" style="background: var(--success-color);">
        <h5 class="mb-0">
            <i class="fas fa-gift me-2"></i>ðŸŽ‰ Job Offers
        </h5>
    </div>
    <div class="card-body">
        <div class="row g-4">
            {% for offer in job_offers %}
            <div class="col-lg-6">
                <div class="offer-card p-4 rounded-lg shadow-md">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h6 class="text-white mb-1">
                                <i class="fas fa-building me-2"></i>{{ offer.company_name }}
                            </h6>
                            <p class="text-dark mb-0 small">{{ offer.job_type }}</p>
                        </div>
                        <div class="text-end">
                            <div class="badge bg-primary text-white">{{ offer.salary_tier }}</div>
                        </div>
                    </div>
                    
                    <h5 class="text-white mb-3">{{ offer.job_role }}</h5>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-6">
                            <div class="text-center">
                                <i class="fas fa-money-bill-wave text-white-50 mb-1"></i>
                                <div class="text-white-50 small mb-1">Package</div>
                                <div class="text-white fw-bold">â‚¹{{ offer.ctc }} LPA</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <i class="fas fa-clock text-white-50 mb-1"></i>
                                <div class="text-white-50 small mb-1">Respond by</div>
                                <div class="text-white fw-bold">{{ offer.act_by_date | format_date }}</div>
                            </div>
                        </div>
                    </div>
                    
                    {% if not offer.action or offer.action == 'PENDING' %}
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-success flex-fill accept-offer-btn" 
                                data-job-id="{{ offer.job_id }}" 
                                data-company-name="{{ offer.company_name }}">
                            <i class="fas fa-check me-2"></i>Accept
                        </button>
                        <button type="button" class="btn btn-light flex-fill reject-offer-btn" 
                                data-job-id="{{ offer.job_id }}" 
                                data-company-name="{{ offer.company_name }}">
                            <i class="fas fa-times me-2"></i>Decline
                        </button>
                    </div>
                    {% else %}
                    <div class="text-center">
                        <span class="status-badge {% if offer.action == 'ACCEPTED' %}status-accepted{% elif offer.action == 'REJECTED' %}status-rejected{% else %}status-pending{% endif %}">
                            <i class="fas {% if offer.action == 'ACCEPTED' %}fa-check{% elif offer.action == 'REJECTED' %}fa-times{% else %}fa-clock{% endif %} me-2"></i>
                            {{ offer.action }}
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Applied Jobs Section -->
{% if applied_jobs %}
<div class="card mb-4" id="applications-section">
    <div class="card-header">
        <h5 class="mb-0 text-muted">Applied Jobs</h5>
    </div>
    <div class="card-body">
        {% for job in applied_jobs %}
        <div class="job-card mb-3 p-3 border rounded">
            <h6 class="text-muted">{{ job.job_role }}</h6>
            <p class="mb-2 text-muted">Company: {{ job.company_name }}</p>
            <p class="mb-2 text-muted">Package: â‚¹{{ job.ctc }} LPA</p>
            <p class="mb-2 text-muted">Type: {{ job.job_type }}</p>
            <p class="mb-2 text-muted">Tier: {{ job.salary_tier }}</p>
            <p class="mb-2 text-muted">Apply by: {{ job.apply_by_date | format_date }}</p>
            {% if job.status %}
            <p class="mb-0">
                <span class="badge {% if job.status == 'Accepted' %}bg-success{% elif job.status == 'Rejected' %}bg-danger{% else %}bg-warning{% endif %}">
                    {{ job.status }}
                </span>
            </p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Available Jobs Section -->
{% if jobs %}
<div class="card" id="available-jobs-section">
    <div class="card-header">
        <h5 class="mb-0 text-muted">Available Jobs</h5>
    </div>
    <div class="card-body">
        {% for job in jobs %}
        <div class="job-card mb-3 p-3 border rounded">
            <h6 class="text-muted">{{ job.company_name }} - {{ job.job_role }}</h6>
            <p class="mb-2 text-muted">Package: â‚¹{{ job.ctc }} LPA</p>
            <p class="mb-2 text-muted">Tier: {{ job.salary_tier }}</p>
            <p class="mb-2 text-muted">Industry: {{ job.industry }}</p>
            <p class="mb-2 text-muted">Apply by: {{ job.apply_by_date | format_date }}</p>
            <p class="mb-2 text-muted">CGPA Cutoff: {{ job.cgpa_cutoff }}</p>
            {% if job.can_apply %}
            <form action="{{ url_for('apply_job', job_id=job.job_id) }}" method="POST" style="display: inline;">
                <input type="hidden" name="job_id" value="{{ job.job_id }}">
                <button type="submit" class="btn btn-primary btn-sm">Apply Now</button>
            </form>
            {% else %}
            <button class="btn btn-secondary btn-sm" disabled>Not Eligible</button>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Scheduled Interviews Section -->
{% if interviews %}
<div class="card" id="interviews-section">
    <div class="card-header">
        <h5 class="mb-0 text-muted">Scheduled Interviews</h5>
    </div>
    <div class="card-body">
        {% for interview in interviews %}
        <div class="interview-card mb-3 p-3 border rounded">
            <h6 class="text-muted">{{ interview.company_name }}</h6>
            <p class="mb-2 text-muted"><strong>Date and Time:</strong> {{ interview.interview_date }}</p>
            <!-- <p class="mb-2"><strong>Time:</strong> {{ interview.interview_time }}</p> -->
            <p class="mb-2 text-muted"><strong>Location:</strong> {{ interview.venue }}</p>
            <p class="mb-2 text-muted"><strong>Job Role:</strong> {{ interview.job_role }}</p>
            <p class="mb-2 text-muted"><strong>Package:</strong> â‚¹{{ interview.ctc }} LPA</p>
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<div class="card" id="interviews-section">
    <div class="card-header">
        <h5 class="mb-0 text-muted">Scheduled Interviews</h5>
    </div>
    <div class="card-body">
        <p class="text-muted">No interviews scheduled yet.</p>
    </div>
</div>
{% endif %}

<!-- Job Application Confirmation Modal -->
<div class="modal fade" id="jobApplicationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Application</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="modalJobDetails" class="mb-3"></div>
                <div id="profileSummary">
                    {% if profile %}
                    <p><strong>Your Profile:</strong></p>
                    <ul>
                        <li>CGPA: {{ profile.cgpa }}</li>
                        <li>Branch: {{ profile.branch }}</li>
                        <li>Batch: {{ profile.batch }}</li>
                    </ul>
                    {% endif %}
                </div>
                <p class="text-muted">Are you sure you want to apply for this position?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="applicationForm" method="POST">
                    <button type="submit" class="btn btn-primary">Confirm Application</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<script>
    // Show confetti for success messages
    document.addEventListener('DOMContentLoaded', function() {
        const flashMessages = document.querySelectorAll('.alert-success');
        flashMessages.forEach(message => {
            if (message.textContent.includes('ðŸŽ‰')) {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        });

        // Add event listeners for quick navigation buttons
        document.querySelectorAll('.quick-nav-btn').forEach(button => {
            button.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                const targetElement = document.getElementById(targetId);
                
                if (targetElement) {
                    // Add smooth scrolling with offset for fixed navbar
                    const navbarHeight = 80; // Adjust based on your navbar height
                    const elementPosition = targetElement.getBoundingClientRect().top;
                    const offsetPosition = elementPosition + window.pageYOffset - navbarHeight;

                    window.scrollTo({
                        top: offsetPosition,
                        behavior: 'smooth'
                    });
                    
                    // Add a subtle highlight effect
                    targetElement.style.transition = 'box-shadow 0.3s ease';
                    targetElement.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.3)';
                    
                    setTimeout(() => {
                        targetElement.style.boxShadow = '';
                    }, 2000);
                }
            });
        });

        // Handle navigation from external links with anchors
        function scrollToSection(sectionId) {
            const targetElement = document.getElementById(sectionId);
            if (targetElement) {
                const navbarHeight = 80;
                const elementPosition = targetElement.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - navbarHeight;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: 'smooth'
                });
                
                // Add highlight effect
                targetElement.style.transition = 'box-shadow 0.3s ease';
                targetElement.style.boxShadow = '0 0 20px rgba(59, 130, 246, 0.3)';
                
                setTimeout(() => {
                    targetElement.style.boxShadow = '';
                }, 2000);
            }
        }

        // Check if page was loaded with an anchor and scroll to it
        if (window.location.hash) {
            const sectionId = window.location.hash.substring(1);
            // Small delay to ensure page is fully rendered
            setTimeout(() => {
                scrollToSection(sectionId);
            }, 100);
        }

        // Add event listeners for accept offer buttons
        document.querySelectorAll('.accept-offer-btn').forEach(button => {
            button.addEventListener('click', function() {
                const jobId = this.getAttribute('data-job-id');
                const companyName = this.getAttribute('data-company-name');
                acceptOffer(jobId, companyName);
            });
        });

        // Add event listeners for reject offer buttons
        document.querySelectorAll('.reject-offer-btn').forEach(button => {
            button.addEventListener('click', function() {
                const jobId = this.getAttribute('data-job-id');
                const companyName = this.getAttribute('data-company-name');
                rejectOffer(jobId, companyName);
            });
        });

        // Add submit event listeners to all job application forms
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function(e) {
                console.log('Form submission:', {
                    action: this.action,
                    method: this.method,
                    jobId: this.querySelector('input[name="job_id"]')?.value
                });
            });
        });
    });

    // Function to accept offer
    function acceptOffer(jobId, companyName) {
        if (!confirm(`Are you sure you want to accept the offer from ${companyName}?`)) {
            return;
        }

        fetch(`/student/accept-offer/${jobId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to accept offer');
            }
            return response.json();
        })
        .then(data => {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
            alert('Congratulations! You have accepted the job offer!');
            location.reload();
        })
        .catch(error => {
            console.error('Error accepting offer:', error);
            alert('Failed to accept offer. Please try again.');
        });
    }

    // Function to reject offer
    function rejectOffer(jobId, companyName) {
        if (!confirm(`Are you sure you want to reject the offer from ${companyName}?`)) {
            return;
        }

        fetch(`/student/reject-offer/${jobId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to reject offer');
            }
            return response.json();
        })
        .then(data => {
            alert('You have rejected the job offer.');
            location.reload();
        })
        .catch(error => {
            console.error('Error rejecting offer:', error);
            alert('Failed to reject offer. Please try again.');
        });
    }

    // Automatically hide flash messages after 5 seconds
    setTimeout(function() {
        const flashMessages = document.querySelectorAll('.alert');
        flashMessages.forEach(message => {
            const alert = new bootstrap.Alert(message);
            alert.close();
        });
    }, 5000);
</script>
{% endblock %}