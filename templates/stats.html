{% extends "base.html" %}

{% block title %}SkillSetGo - Placement Statistics{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="text-muted">Placement Statistics</h2>
                <button onclick="exportPDF()" class="btn btn-primary">
                    <i class="fas fa-download me-2"></i>Export as PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row g-4 mb-5">
        <div class="col-lg-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header text-white" style="background: var(--primary-color);">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Mean Package by Branch
                    </h5>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <div style="width: 100%; max-width: 500px; height: 300px;">
                        <canvas id="mean-package-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header text-white" style="background: var(--primary-color);">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>Number of Offers by Branch
                    </h5>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    <div style="width: 100%; max-width: 500px; height: 300px;">
                        <canvas id="offers-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Section -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header text-white" style="background: var(--primary-color);">
                    <h5 class="mb-0">
                        <i class="fas fa-list-alt me-2"></i>Branch-wise Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" style="background-color: var(--bg-secondary);">
                            <thead style="background: var(--primary-color);">
                                <tr>
                                    <th class="text-white fw-semibold">Branch</th>
                                    <th class="text-white fw-semibold">Mean Package (LPA)</th>
                                    <th class="text-white fw-semibold">Number of Offers</th>
                                </tr>
                            </thead>
                            <tbody id="summary-table" style="background-color: var(--bg-secondary);">
                                <!-- Data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script>
    const stats = {{ stats | tojson }};
    
    // Prepare data for charts
    const branches = stats.map(stat => stat.branch);
    const meanPackages = stats.map(stat => stat.mean_lpa);
    const offers = stats.map(stat => stat.number_of_offers);

    // Chart configuration with consistent styling
    const chartConfig = {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                labels: {
                    color: '#6b7280',
                    font: {
                        family: 'Inter'
                    }
                }
            }
        },
        scales: {
            x: {
                ticks: {
                    color: '#6b7280',
                    font: {
                        family: 'Inter'
                    }
                },
                grid: {
                    color: '#e5e7eb'
                }
            },
            y: {
                beginAtZero: true,
                ticks: {
                    color: '#6b7280',
                    font: {
                        family: 'Inter'
                    }
                },
                grid: {
                    color: '#e5e7eb'
                }
            }
        }
    };

    // Create mean package chart
    const meanPackageCtx = document.getElementById('mean-package-chart').getContext('2d');
    new Chart(meanPackageCtx, {
        type: 'bar',
        data: {
            labels: branches,
            datasets: [{
                label: 'Mean Package (LPA)',
                data: meanPackages,
                backgroundColor: '#3b82f6',
                borderColor: '#2563eb',
                borderWidth: 1,
                borderRadius: 8,
                borderSkipped: false,
            }]
        },
        options: chartConfig
    });

    // Create offers chart
    const offersCtx = document.getElementById('offers-chart').getContext('2d');
    new Chart(offersCtx, {
        type: 'bar',
        data: {
            labels: branches,
            datasets: [{
                label: 'Number of Offers',
                data: offers,
                backgroundColor: '#10b981',
                borderColor: '#059669',
                borderWidth: 1,
                borderRadius: 8,
                borderSkipped: false,
            }]
        },
        options: chartConfig
    });

    // Populate summary table
    const summaryTable = document.getElementById('summary-table');
    summaryTable.innerHTML = stats.map(stat => `
        <tr>
            <td class="text-muted fw-semibold">${stat.branch}</td>
            <td class="text-muted">₹${stat.mean_lpa}</td>
            <td class="text-muted">${stat.number_of_offers}</td>
        </tr>
    `).join('');

    // Enhanced PDF export function
    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header
        doc.setFontSize(20);
        doc.setTextColor(59, 130, 246); // Primary blue
        doc.text('SkillSetGo', 20, 20);
        
        doc.setFontSize(16);
        doc.setTextColor(107, 114, 128); // Muted gray
        doc.text('Placement Statistics Report', 20, 30);
        
        doc.setFontSize(10);
        doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 20, 40);

        // Add charts
        doc.setFontSize(14);
        doc.setTextColor(107, 114, 128);
        doc.text('Mean Package by Branch (LPA)', 20, 55);
        doc.addImage(meanPackageCtx.canvas.toDataURL('image/png'), 'PNG', 20, 65, 170, 80);

        doc.text('Number of Offers by Branch', 20, 155);
        doc.addImage(offersCtx.canvas.toDataURL('image/png'), 'PNG', 20, 165, 170, 80);

        // Add summary table on new page
        doc.addPage();
        doc.setFontSize(16);
        doc.setTextColor(107, 114, 128);
        doc.text('Branch-wise Summary', 20, 20);

        let yPosition = 35;
        doc.setFontSize(10);
        doc.text('Branch', 20, yPosition);
        doc.text('Mean Package (LPA)', 80, yPosition);
        doc.text('Number of Offers', 140, yPosition);
        
        yPosition += 10;
        stats.forEach(stat => {
            doc.text(stat.branch, 20, yPosition);
            doc.text(`₹${stat.mean_lpa}`, 80, yPosition);
            doc.text(stat.number_of_offers.toString(), 140, yPosition);
            yPosition += 8;
        });

        doc.save('placement_statistics.pdf');
    }
</script>
{% endblock %}